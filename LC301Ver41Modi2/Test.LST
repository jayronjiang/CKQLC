C51 COMPILER V9.53.0.0   TEST                                                              04/19/2016 15:08:42 PAGE 1   


C51 COMPILER V9.53.0.0, COMPILATION OF MODULE TEST
OBJECT MODULE PLACED IN Test.OBJ
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Test.c OPTIMIZE(8,SPEED) DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          /*************************************************************************************************
   2          车道控制器测试老化程序
   3          版本: Version 1.0
   4          修订: Liu XingZhou
   5          时间: 
   6          
   7          设计说明:  
   8              1.程序启动时候检测输入端口，如果P2.6输入端口均有输入(有电压或者关合开关信号)，则
   9                转入本程序。
  10              2.本程序不断定期地从输出端(继电器/语音/RS485费显)输出数据和控制信号
  11          注意事项: 
  12              使用时
  13          其它信息: 
  14          C_CHAR1.0 - AutoBar up signal
  15          C_CHAR1.1 - AutoBar down signal
  16          C_CHAR1.2 - TTL signal, 1: green, 0:red
  17          C_CHAR1.3 - VoiceAlarm enable signal
  18          C_CHAR1.4 - LightAlarm enable signal
  19          C_CHAR1.5 - LaneLamp signal, 1:green, 0:red
  20          C_CHAR1.6 - Reserved for later using
  21          C_CHAR1.7 - Reserved for later using
  22          
  23          C_BAK.0 - enable AutoBarUp Mode (0:ManulBarUp Mode)
  24          C_BAK.1 - enable FeeDisplay
  25          C_BAK.2 - enable Speaker
  26          C_BAK.3 - enable KeepFeeDisplay
  27          *************************************************************************************************/
  28          //Directions End
  29          //================================================================================================
  30          #include <reg52.h>
  31          #include <intrins.h>
  32          #include "XY-LC301.h"
  33          //------------------------------------------------------------------------------------------------
  34          #define cLED_COMMUNICATE COMMFLASH
  35          /*const unsigned char FeeTestCommData[]={0x02,'8','8','8','8','8','8','8','8','8','8','8','8','8','8',
  36            '8','8',0x03,0x00};
  37          const unsigned char PlayVoiceCommData[]={0x02,'5','1', '1','2','3','4','4','3','2','1',
  38            0xBB,0xBC,0xCC,0xCD,0xDD,0xDE,0x03,0x01};
  39          */
  40          extern void FeedDog(void);
  41          //================================================================================================
  42          void delay_ms(unsigned char n_ms) //OSC = 11.0592Mhz
  43          {
  44   1        unsigned char j;
  45   1      
  46   1        while(n_ms--)
  47   1        {
  48   2          for(j=0;j<250;j++)
  49   2          {
  50   3            WDT=1;
  51   3            _nop_();
  52   3            WDT=0;
  53   3            _nop_();
  54   3          }
  55   2        }
C51 COMPILER V9.53.0.0   TEST                                                              04/19/2016 15:08:42 PAGE 2   

  56   1      }
  57          //=================================================================================================
  58          bit comm_send_char(unsigned char out_char)
  59          {
  60   1        int time_out=1000;
  61   1        bit ret = 1;
  62   1      
  63   1        FeedDog();
  64   1        cLED_COMMUNICATE=1; //0 to light communication led
  65   1        TI = 0;
  66   1        SBUF = out_char;
  67   1        while(!TI)
  68   1        {
  69   2          if(time_out--) continue;
  70   2          ret =0;
  71   2          break;
  72   2        }
  73   1        TI=0;
  74   1        cLED_COMMUNICATE=0; //shut communication led
  75   1        return ret;
  76   1      }
  77          //================================================================================================
  78          
  79          bit InputDedect()
  80          {
  81   1        unsigned char tmpInport;
  82   1      
  83   1        FeedDog();
  84   1        tmpInport=P2;
  85   1        if((tmpInport&0x40)==0)
  86   1        {
  87   2          delay_ms(5);
  88   2          tmpInport=P2;
  89   2          if((tmpInport&0x40)==0)
  90   2            return 1;
  91   2        }
  92   1        return 0;
  93   1      }
  94          //================================================================================================
  95          void UpdateFeeDisplay(unsigned char Index)
  96          {
  97   1        TOVOX=0;TOFEE=1;TOCPU=0;
  98   1      
  99   1        FeedDog();
 100   1        if(Index%2)
 101   1        {
 102   2          comm_send_char(0x02); //Close Lane lamp
 103   2          comm_send_char('Z');
 104   2          comm_send_char(0x03);
 105   2          comm_send_char('Z');
 106   2      
 107   2          delay_ms(250);
 108   2      
 109   2          comm_send_char(0x02);
 110   2          comm_send_char('8');
 111   2          comm_send_char('8');
 112   2          comm_send_char('8');
 113   2          comm_send_char('8');
 114   2          comm_send_char('8');
 115   2          comm_send_char('8');
 116   2          comm_send_char('8');
 117   2          comm_send_char('8');
C51 COMPILER V9.53.0.0   TEST                                                              04/19/2016 15:08:42 PAGE 3   

 118   2          comm_send_char('8');
 119   2          comm_send_char('8');
 120   2          comm_send_char('8');
 121   2          comm_send_char('8');
 122   2          comm_send_char('8');
 123   2          comm_send_char('8');
 124   2          comm_send_char('8');
 125   2          comm_send_char('8');
 126   2          comm_send_char(0x03);
 127   2          comm_send_char(0x00);
 128   2        }
 129   1        else
 130   1        {
 131   2          comm_send_char(0x02); //Open Lane lamp
 132   2          comm_send_char('Y');
 133   2          comm_send_char(0x03);
 134   2          comm_send_char('Y');
 135   2        }
 136   1        TOVOX=0;TOFEE=0;TOCPU=1;
 137   1      }
 138          //================================================================================================
 139          void PlayVoice(unsigned char Index)
 140          {
 141   1        TOVOX=1;TOFEE=0;TOCPU=0;
 142   1      
 143   1        FeedDog();
 144   1        if(Index%5)
 145   1        {
 146   2          comm_send_char(0x02);
 147   2          comm_send_char('5');
 148   2          comm_send_char('1');
 149   2          comm_send_char('1');
 150   2          comm_send_char('2');
 151   2          comm_send_char('3');
 152   2          comm_send_char('4');
 153   2          comm_send_char('4');
 154   2          comm_send_char('3');
 155   2          comm_send_char('2');
 156   2          comm_send_char('1');
 157   2          comm_send_char(0xBB);
 158   2          comm_send_char(0xBC);
 159   2          comm_send_char(0xCC);
 160   2          comm_send_char(0xCD);
 161   2          comm_send_char(0xDD);
 162   2          comm_send_char(0xDE);
 163   2          comm_send_char(0x03);
 164   2          comm_send_char(0x01);
 165   2        }
 166   1        else
 167   1        {
 168   2          comm_send_char(0x02);
 169   2          comm_send_char('Y');
 170   2          comm_send_char(0x03);
 171   2          comm_send_char('Y');
 172   2        }
 173   1      
 174   1        TOVOX=0;TOFEE=0;TOCPU=1;
 175   1      }
 176          //================================================================================================
 177          SetControlPort(bit bOnOff)
 178          {
 179   1        unsigned char tmpPortData;
C51 COMPILER V9.53.0.0   TEST                                                              04/19/2016 15:08:42 PAGE 4   

 180   1      
 181   1        FeedDog();
 182   1        P0=0xFE;
 183   1        for(tmpPortData=0;tmpPortData<16;tmpPortData++)
 184   1        {
 185   2          P0<<=1;
 186   2          delay_ms(10);
 187   2        }
 188   1        delay_ms(200);
 189   1        delay_ms(200);
 190   1        
 191   1        tmpPortData=0xFF;
 192   1        if(bOnOff) tmpPortData=0; //set on
 193   1      
 194   1        P0=tmpPortData;
 195   1        delay_ms(2);
 196   1        P0=tmpPortData|0x03;
 197   1      }
 198          //================================================================================================
 199          void DelayLong(unsigned char Times)
 200          {
 201   1        static int i;
 202   1      
 203   1        FeedDog();
 204   1        for(i=0;i<Times;i++)
 205   1        {
 206   2          delay_ms(200);
 207   2         }
 208   1      }
 209          //================================================================================================
 210          void TestForLC301(void)
 211          {
 212   1        unsigned char Index=0;
 213   1        if(!InputDedect()) return;
 214   1      
 215   1        FeedDog();
 216   1        while(1)
 217   1        {
 218   2          WDT=1;
 219   2              WDT=0;
 220   2          UpdateFeeDisplay(Index);
 221   2          PlayVoice(Index);
 222   2          SetControlPort(1);
 223   2      
 224   2          DelayLong(10);
 225   2      
 226   2          SetControlPort(0);
 227   2          
 228   2          delay_ms(50);
 229   2          Index++;
 230   2        }
 231   1        return;
 232   1      }
 233          
 234          //================================================================================================
 235          
*** WARNING C290 IN LINE 197 OF Test.c: missing return value


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    535    ----
   CONSTANT SIZE    =   ----    ----
C51 COMPILER V9.53.0.0   TEST                                                              04/19/2016 15:08:42 PAGE 5   

   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      2       7
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       2
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
