C51 COMPILER V8.18   XY_LC301                                                              06/27/2012 09:59:54 PAGE 1   


C51 COMPILER V8.18, COMPILATION OF MODULE XY_LC301
OBJECT MODULE PLACED IN XY-LC301.OBJ
COMPILER INVOKED BY: E:\Keil\C51\BIN\C51.EXE XY-LC301.C DEBUG OBJECTEXTEND

line level    source

   1          
   2          /***************************************************************************
   3          Modula:    XY-LC-301
   4          Version:   4.1
   5          Revisor:   Liu XingZhou
   6          StartDate: 2004/04/05
   7          LastUpdate:2008/06/08
   8          ***************************************************************************/
   9          
  10          //#define TEST
  11          //#define _DEBUG
  12          //#pragma ot(0,speed)
  13          
  14          //==============================================================================================
  15          #include <Reg52.h>
  16          #include <intrins.h>
  17          #include "XY-LC301.h"
  18          //=============================================================================================
  19          #ifdef _DEBUG
              char code VerInfo[]="LC-301-V4.1-debug";
              #else
  22          char code VerInfo[]="LC-301-V4.1-08073";
  23          #endif
  24          char code *CodeMark[]={
  25              "CODEMARK[Lane Control for general purpose use.",
  26              __DATE__,
  27              "]"
  28          };
  29          //---------------------------------------------------------------------------------------------
  30          bit bdata buffer_star;
  31          bit bdata buffer_sto;
  32          bit bdata message_right;
  33          bit bdata message_wrong;
  34          bit bdata dete_change;
  35          bit bdata bTTL_ALG_Wrong;
  36          
  37          bit bdata bEnBarAutoDown;
  38          bit bdata con_speak_fee;
  39          bit bdata dete_bit_recd;
  40          
  41          bit bdata alarm_flag;
  42          
  43          bit bdata TTL_working_wrong;    //TongXing Lamp
  44          bit bdata ALG_working_wrong;    //Auto-LanGan
  45          
  46          bit bdata ALG_up_flag_bit;
  47          bit bdata ALG_down_flag_bit;
  48          bit bdata LastLaneLampState;
  49          bit bdata watching_car_passing; //ÓÃÓÚ·ÀÔÒ¹¦ÄÜ:ÔÚ³µÁ¾´ÓÏßÈ¦Àë¿ª¡¢½µ¸ÍµÄ¹ý³ÌÖÃ1£¬Æô¶¯·ÀÔÒ¼àÊÓ,À¸¸Ë³¹µ×½µÏÂ»
             -òÔò½ÓÊÕµ½Ì§¸ËÃüÁî£¬ÖÃ0£¬Í£Ö¹¼àÊÓ
  50          
  51          bit bdata bLastLaneRedGreenOperateState;
  52          bit bdata bALGTTLAutoDetect;
  53          bit bdata bFeeCleared;
  54          bit bdata bTXok;
C51 COMPILER V8.18   XY_LC301                                                              06/27/2012 09:59:54 PAGE 2   

  55          
  56          unsigned char data COMM_buff[COMM_LENTH];
  57          unsigned char data send_addr;
  58          unsigned char data tmp_use1;
  59          unsigned char data alarm_time_counter;
  60          unsigned char data detect_time_counter; 
  61          
  62          unsigned char data ReceiveIndicateCount;
  63          unsigned char data ReceiveTimeoutCount;
  64          
  65          unsigned char data WatchingDelayCount=0;
  66          //-----------------------------------------------------------------------------
  67          unsigned char bdata control_char1;         //'A' TYPE message
  68          sbit  ALG_up_bit      =control_char1^0; 
  69          sbit  ALG_down_bit    =control_char1^1;
  70          sbit  TTL_green_bit   =control_char1^2;
  71          sbit  VOX_alarm_bit   =control_char1^3;
  72          sbit  Light_alarm_bit =control_char1^4;
  73          sbit  Lane_lamp_bit   =control_char1^5;         //CheDao TongXing Lamp
  74          sbit  control_bak1_bit=control_char1^6;
  75          sbit  control_bak2_bit=control_char1^7;
  76          
  77          unsigned char bdata control_char_bak2;                  //'A' type message
  78          sbit  ALG_control_mode  =control_char_bak2^0;   //Mode: Auto LG or Manual LG
  79          sbit  FEE_display_bit   =control_char_bak2^1;
  80          sbit  SPEAK_control_bit =control_char_bak2^2;
  81          sbit  FEE_displaykeep_bit=control_char_bak2^3;  //ÓÃÓÚ¹¦ÄÜ£ºÂÌµÆºó£¬·ÑÏÔÈÔÈ»±£³Ö
  82          
  83          sbit  bFeeDispSelection =control_char_bak2^4;   //·ÑÏÔÑ¡Ôñ£¬1-ÎÞ±£³Ö¹¦ÄÜµÄ¹ã¶«ÓÃ°æ±¾£¬0-ÓÐ±£³Ö¹¦ÄÜµÄÉ½Î÷°æ±¾
  84          sbit  bControlOption    =control_char_bak2^5;   //³µ¿ØÆ÷Ê¹ÓÃÊôÐÔ: 1-³ö¿Ú, 0-Èë¿Ú
  85          sbit  bFeeDispReserved2 =control_char_bak2^6;
  86          
  87          //-----------------------------------------------------------------------------
  88          unsigned char bdata  device_status_char1;       //'B' type message
  89          sbit  TTL_detect_bit   =device_status_char1^0;
  90          sbit  LG_detect_bit    =device_status_char1^1;
  91          sbit  ALarm_detect_bit =device_status_char1^2;
  92          sbit  ALG_detect_bit   =device_status_char1^3;
  93          sbit  FRONT_coil_bit   =device_status_char1^4;
  94          sbit  BACK_coil_bit    =device_status_char1^5;
  95          sbit  bakup_detect1_bit=device_status_char1^6;
  96          sbit  bakup_detect2_bit=device_status_char1^7;
  97          
  98           
  99          unsigned char bdata device_status_bakused;      //'B' type message 
 100          sbit  ALG_work_status=device_status_bakused^2;
 101          sbit  TTL_work_status=device_status_bakused^6;
 102          
 103          unsigned char bdata sys_tmep;                 //auto detect system used
 104          sbit sys_tmep_b7=sys_tmep^7;
 105          sbit sys_tmep_b6=sys_tmep^6;
 106          sbit sys_tmep_b5=sys_tmep^5;
 107          sbit sys_tmep_b4=sys_tmep^4;
 108          sbit sys_tmep_b3=sys_tmep^3;
 109          sbit sys_tmep_b2=sys_tmep^2;
 110          sbit sys_tmep_b1=sys_tmep^1;
 111          sbit sys_tmep_b0=sys_tmep^0;
 112          
 113          char data PowerOnFlag;          //this byte do NOT to initialize
 114          //==============================================================================================
 115          void InitSys(void);
 116          void PrintVerInfo(void);
C51 COMPILER V8.18   XY_LC301                                                              06/27/2012 09:59:54 PAGE 3   

 117          void DumpMemory(void);
 118          void Uart1IntEntry(void);
 119          void FeedDog(void);
 120          void ddl_200us(int x);
 121          void send_mess(unsigned char);
 122          void judge_rec_message(void);
 123          void detect_device(void);
 124          void control_device(void);
 125          void control_speaker(void);
 126          void device_keep(void);
 127          void system_auto_detect(void);
 128          
 129          void delay_10s(void);
 130          void ONE_FEEdisplay_Red(void);
 131          void ONE_FEEdisplay_Green(void);
 132          void ClearFEEdisplay(void);
 133          
 134          bit  detect_ALG_TTL_working(void);
 135          void send_test();
 136          void InitApp(void);
 137          char GetControlChar(void);
 138          //--------------------------------- additional -------------------------------------------------
 139          void UpdateFEEdisplay(void);
 140          void BarOpRectifyLaneLamp(void);
 141          bit  AutoBarDowningDetect(void);
 142          //--------------------------------- extenal ----------------------------------------------------
 143          extern void TestForLC301(void); //added 0405
 144          //==============================================================================================
 145          void main(void)
 146          {
 147   1              char FlashTimes=3;
 148   1                      ddl_200us(200);
 149   1              do
 150   1              {
 151   2                      COMMFLASH=1;
 152   2                      ddl_200us(64);
 153   2                      COMMFLASH=0;
 154   2                      ddl_200us(64);
 155   2                      FlashTimes--;
 156   2              }while(FlashTimes>0);
 157   1      
 158   1              InitSys();
 159   1              if(PowerOnFlag!=(char)0xAA)
 160   1              {
 161   2                      PowerOnFlag=(char)0xAA;
 162   2                      system_auto_detect();
 163   2                      InitApp();
 164   2      
 165   2                      ALG_down_bit=1;
 166   2                      ALG_up_bit=0;
 167   2                      TTL_green_bit=0;
 168   2                      VOX_alarm_bit=0;
 169   2                      Light_alarm_bit=0;
 170   2                      Lane_lamp_bit=0;
 171   2                      control_bak1_bit=0;
 172   2                      control_bak2_bit=0;
 173   2              }
 174   1              else
 175   1                      PrintVerInfo();         //poweron info, used for debugging
 176   1      
 177   1              control_device();               //power on ,control TTL red and ALG down
 178   1      
C51 COMPILER V8.18   XY_LC301                                                              06/27/2012 09:59:54 PAGE 4   

 179   1      
 180   1              TestForLC301(); //ÓÃÓÚÀÏ»¯²âÊÔ
 181   1      
 182   1              while(1)
 183   1              {
 184   2                      WDT=!WDT;
 185   2      
 186   2                      //------------´¦Àí½ÓÊÕÃüÁî ²¿·Ö ------------------
 187   2                      if(buffer_sto==1)
 188   2                      {
 189   3                              buffer_sto=0;
 190   3                              FeedDog();
 191   3                              judge_rec_message();
 192   3                              if(message_right==1)
 193   3                              {
 194   4                                      message_right=0;
 195   4                                      FeedDog();
 196   4                                      if(COMM_buff[2]!='1') continue; //Ö»ÓÐÊÇ±¾»úµØÖ·²Å¶ÔÉè±¸½øÐÐ¿ØÖÆ
 197   4                                      if((COMM_buff[1]=='C')&&(COMM_buff[3]=='R')) {while(1);}
 198   4                                      if((COMM_buff[1]=='C')&&(COMM_buff[3]=='V')) {PrintVerInfo(); continue;}
 199   4                                      if((COMM_buff[1]=='C')&&(COMM_buff[3]=='D')) {DumpMemory(); continue;}
 200   4                                      //if(COMM_buff[1]!='A') continue;       //ÒÔÏÂÖ»´¦ÀíBÀàÐÅÏ¢
 201   4      
 202   4                                      detect_ALG_TTL_working();
 203   4                                      send_mess(0x02);
 204   4                                      send_mess('B');
 205   4                                      send_mess('1');
 206   4                                      send_mess(device_status_char1);
 207   4                                      send_mess(device_status_bakused);
 208   4                                      send_mess(0x03);
 209   4                                      tmp_use1=('B')^('1');
 210   4                                      tmp_use1=tmp_use1^(device_status_bakused);
 211   4                                      tmp_use1=tmp_use1^device_status_char1;              
 212   4                                      send_mess(tmp_use1);
 213   4      
 214   4      
 215   4                                      //ÍâÉè¿ØÖÆ(×¢Òâ±£³ÖÔÚÆäËû¿ØÖÆÖ®Ç°)
 216   4                                      control_char_bak2=COMM_buff[20];
 217   4                                      control_char1=COMM_buff[3];
 218   4                                      if(ALG_up_bit)
 219   4                                      {
 220   5                                              bEnBarAutoDown=ALG_control_mode;        //×Ô¶¯½µ¸ËÄ£Ê½
 221   5                                              ALG_control_mode=0;                                     //Çå³ý¸ÃÉèÖÃÎ», ÉÇ·Ò³±ÖÝÕ¾¾ü¾¯³µµÀÒ£¿ØÀ¸¸Ë»úÐèÇó·¢Æð
 222   5                                              watching_car_passing=0;
 223   5                                              if(BACK_coil_bit==0){
 224   6                                                      dete_bit_recd=1;                //Ì§¸Ëºó¿ªÊ¼¼ÆºóÏßÈ¦ÓÐÎÞ³µ¹ý P20100603£«
 225   6                                              }else dete_bit_recd=0;
 226   5                                      }
 227   4                                      BarOpRectifyLaneLamp();                                 //¸ù¾ÝÏÖ³¡±»¿ØÉè±¸Âß¼­Çé¿ö£¬µ÷Õû¿ØÖÆÎ»
 228   4                                      control_device();
 229   4      
 230   4      
 231   4                                      //ÑïÉùÆ÷²Ù×÷
 232   4                                      if(SPEAK_control_bit==1)
 233   4                                      {
 234   5                                              control_speaker();
 235   5                                      }
 236   4                                      else ddl_200us(250);            //¸Ã´¦ÑÓÊ±Ô¼µÈÓÚifÄÚµÄÊ±¼ä£¬±£Ö¤Á¬Ðø¶Ô·ÑÏÔµÄ²Ù×÷µÄ¼ä¸ôÊ±¼ä
 237   4      
 238   4                                      
 239   4                                      //·Ñ¶îÏÔÊ¾²Ù×÷
 240   4                                      if(FEE_displaykeep_bit==0)
C51 COMPILER V8.18   XY_LC301                                                              06/27/2012 09:59:54 PAGE 5   

 241   4                                      {
 242   5                                              if(FEE_display_bit==1)          
 243   5                                                      UpdateFEEdisplay();             //ÏÔÊ¾·ÑÓÃÓà¶î
 244   5                                              else ClearFEEdisplay();         //Çå³ý·Ñ¶î£¬´òºìµÆ(ÓÐÐ©´òÂÌµÆÒ²¿ÉÒÔ)¾ÍÇå³ý·Ñ¶îÏÔÊ¾
 245   5                                      }
 246   4                              }
 247   3      
 248   3                              if(message_wrong==1)
 249   3                              {
 250   4                                      message_wrong=0;
 251   4                                      send_mess(0x15);
 252   4                                      for(send_addr=0;send_addr<=3;send_addr++)
 253   4                                              send_mess('E');
 254   4                                      send_mess(0x03);
 255   4                                      send_mess(0x00);
 256   4                              }
 257   3                      }
 258   2      
 259   2              
 260   2                      //------------¼ì²â×´Ì¬²¿·Ö ------------------
 261   2                      WDT=!WDT;
 262   2                      detect_device();
 263   2      
 264   2                      #ifdef TEST
                              if(TTL_detect_bit==0)   //ÕâÁ½ÐÐ´úÂëÔÚÉ½Î÷Ì«¾ÉÖÐÊ¹ÓÃ£¬µ«²»ÖªµÀÓÃÓÚÊ²Ã´Ä¿µÄ
                                      send_test();
                              #endif
 268   2      
 269   2                      if(dete_change==1)
 270   2                      {
 271   3                              dete_change=0;
 272   3                              detect_ALG_TTL_working();
 273   3                              send_mess(0x02); send_mess('B'); send_mess('1');
 274   3                              send_mess(device_status_char1);
 275   3                              send_mess(device_status_bakused);
 276   3                              send_mess(0x03);
 277   3                              tmp_use1='B'^'1';
 278   3                              tmp_use1=tmp_use1^device_status_bakused;
 279   3                              tmp_use1=tmp_use1^device_status_char1;              
 280   3                              send_mess(tmp_use1);
 281   3                                           
 282   3                              if(BACK_coil_bit==0)    
 283   3                                      dete_bit_recd=1;        ////if car on coil, record set
 284   3                      }
 285   2      
 286   2      
 287   2                      //·ÀÖ¹ÔÒ³µ¹¦ÄÜ£¬ÒÔÉÏ×¢ÊÍ²¿·ÖµÄ¸Ä½ø
 288   2                      WDT=!WDT;
 289   2                      if(watching_car_passing){
 290   3                      if(BACK_coil_bit==0)    //ºóÏßÈ¦ÓÐ³µ
 291   3                      {
 292   4                              if(ALG_down_flag_bit&ALG_detect_bit)    //ÕýÔÚ½µÂä...
 293   4                              {
 294   5                                      ALG_up_bit=1;
 295   5                                      ALG_down_bit=0;
 296   5                                      control_device();
 297   5                                      bEnBarAutoDown=1; 
 298   5                              }
 299   4                      }}
 300   2      
 301   2                      if(ALarm_detect_bit==0) //valid is 0
 302   2                      {
C51 COMPILER V8.18   XY_LC301                                                              06/27/2012 09:59:54 PAGE 6   

 303   3                              alarm_time_counter=ALARM_TIME;
 304   3                              VOX_alarm_bit=1;
 305   3                              Light_alarm_bit=1;
 306   3                              device_keep();
 307   3                      }
 308   2      
 309   2                      //×Ô¶¯½µÀ¸¸Ë
 310   2                      WDT=!WDT;
 311   2                      if(bEnBarAutoDown==1)                   
 312   2                      {
 313   3                              if(BACK_coil_bit==1)            //Back Coil Flag =1, No Car
 314   3                              {
 315   4                                      if(dete_bit_recd==1)    //Car ever on Coil last time, this 2 line indicate Car leave Coil
 316   4                                      {
 317   5                                              dete_bit_recd=0;
 318   5                                              bEnBarAutoDown=0;       //¸´Î»ÎªÊÖ¶¯½µÀ¸¸ËÄ£Ê½
 319   5                                              ALG_down_bit=1;
 320   5                                              ALG_up_bit=0;
 321   5                                              Lane_lamp_bit=0;        //red
 322   5                                              control_device();
 323   5                                              watching_car_passing=1; 
 324   5                                      }
 325   4                              }
 326   3                      }
 327   2                              
 328   2                      WDT=!WDT;
 329   2                      if(bALGTTLAutoDetect)           //Éè±¸´íÎó×´Ì¬×Ô¶¯¼ì²â²¿·Ö
 330   2                      {
 331   3                              bALGTTLAutoDetect=0;
 332   3                      if(detect_ALG_TTL_working())
 333   3                              {
 334   4                                      bTTL_ALG_Wrong=1;                       //Èç¹ûÊÇ´íÎó×´Ì¬£¬Ã¿µ±¸Ã±êÖ¾ÖÃÎ»Ê±ÏòÉÏÎ»»ú»ã±¨
 335   4                                      dete_change=1;
 336   4                              }
 337   3                              else
 338   3                              {
 339   4                                      if(bTTL_ALG_Wrong) dete_change=1;       //´Ó´íÎó×´Ì¬·µ»Øµ½Õý³£×´Ì¬Ê±£¬¼°Ê±ÏòÉÏÎ»»ú»ã±¨
 340   4                                      bTTL_ALG_Wrong=0;
 341   4                              }
 342   3                      }
 343   2                      WDT=!WDT;
 344   2              }
 345   1      }
 346          //==============================================================================================
 347          //SysInit.c
 348          
 349          /******************************************************
 350          XY-LC-301 BASIC INITIALIZATION SECTION
 351          ******************************************************/
 352          void PrintVerInfo(void)
 353          {
 354   1              char i=0;
 355   1              char chr;
 356   1              chr=VerInfo[i];
 357   1      
 358   1              FeedDog();
 359   1              send_mess('X');
 360   1              send_mess('Y');
 361   1              send_mess('-');
 362   1              while(chr!=0)
 363   1              {
 364   2                      send_mess(chr);
C51 COMPILER V8.18   XY_LC301                                                              06/27/2012 09:59:54 PAGE 7   

 365   2                      i++;
 366   2                      chr=VerInfo[i];
 367   2              }
 368   1              send_mess(0x0D);
 369   1              send_mess(0x0A);
 370   1      }
 371          void DumpMemory(void)
 372          {
 373   1              unsigned char *pMem=0;  
 374   1      
 375   1      
 376   1              FeedDog();
 377   1              send_mess('X');
 378   1              send_mess('Y');
 379   1              send_mess('_');
 380   1              while(pMem<0x80)
 381   1              {
 382   2                      send_mess((char)*pMem);
 383   2                      pMem++;
 384   2              }
 385   1              send_mess(0x0D);
 386   1              send_mess(0x0A);
 387   1      }
 388          //==============================================================================================
 389          void InitSys(void)
 390          {
 391   1            SCON=0x40;
 392   1            TMOD=0x21;
 393   1            TH1=0xFD;//9600bps when in 11.0592Mhz
 394   1            TL1=0xFD;
 395   1            TR1=1;
 396   1            ES=1;
 397   1            REN=1;
 398   1      
 399   1                TR0=1;
 400   1                ET0=1;
 401   1                PS=1;
 402   1      
 403   1              TOVOX=0;
 404   1              TOFEE=0;
 405   1              TOCPU=1;
 406   1      
 407   1                EA=1;
 408   1      }
 409          //==============================================================================================
 410          void InitApp(void)
 411          {  
 412   1              char i;    
 413   1      
 414   1              FeedDog();
 415   1              BAR_UP=1;
 416   1              BAR_DOWN=1;
 417   1              TTL_GREEN=1;
 418   1              VOX_ALM=1;
 419   1              LIGHT_ALM=1;
 420   1              LAN_LAMP=1;
 421   1              BAK1_USED=1;
 422   1              BAK2_USED=1;
 423   1          
 424   1              alarm_time_counter=0;
 425   1              tmp_use1=0;
 426   1              send_addr=0;
C51 COMPILER V8.18   XY_LC301                                                              06/27/2012 09:59:54 PAGE 8   

 427   1              sys_tmep=0;
 428   1              control_char_bak2=0;
 429   1              control_char1=0;
 430   1              device_status_char1=0x00;               //all device disconnected
 431   1              device_status_bakused=0xbb;             //system default, all device are good
 432   1              detect_time_counter=AUTO_DETCET_TIME;
 433   1              for(i=0; i<COMM_LENTH; i++)
 434   1                      COMM_buff[i]=0;
 435   1      
 436   1              ReceiveIndicateCount=0;
 437   1              ReceiveTimeoutCount=RECEIVE_TIMEOUT;
 438   1      
 439   1              buffer_star=0;
 440   1              buffer_sto=0;
 441   1              message_right=0;
 442   1              message_wrong=0;
 443   1              dete_change=0;
 444   1      
 445   1              bEnBarAutoDown=0;
 446   1              con_speak_fee=0;
 447   1              dete_bit_recd=0;
 448   1      
 449   1              alarm_flag=0;
 450   1              TTL_working_wrong=0;    //TongXing Lamp
 451   1              ALG_working_wrong=0;    //Auto-LanGan
 452   1              ALG_up_flag_bit=0;
 453   1              ALG_down_flag_bit=0;
 454   1              LastLaneLampState=0;
 455   1              watching_car_passing=0; //ÓÃÓÚ·ÀÔÒ¹¦ÄÜ:ÔÚ³µÁ¾´ÓÏßÈ¦Àë¿ª¡¢½µ¸ÍµÄ¹ý³ÌÖÃ1£¬Æô¶¯·ÀÔÒ¼àÊÓ,À¸¸Ë³¹µ×½µÏÂ»òÔò½ÓÊÕ
             -µ½Ì§¸ËÃüÁî£¬ÖÃ0£¬Í£Ö¹¼àÊÓ
 456   1              bLastLaneRedGreenOperateState=0;
 457   1              bALGTTLAutoDetect=0; 
 458   1              bFeeCleared=0;
 459   1              bTTL_ALG_Wrong=0;
 460   1              bTXok=0;
 461   1      }
 462          
 463          //==============================================================================================
 464          void init_uart1() interrupt 4 using 3
 465          {
 466   1              static unsigned char data tmp,rec_counter;
 467   1        
 468   1              if(RI)
 469   1              {
 470   2                      RI=0;
 471   2                      WDT=!WDT;
 472   2                      tmp=SBUF;
 473   2                      if(tmp==0x02&&buffer_star==0)
 474   2                      {
 475   3                              rec_counter=0;
 476   3                              COMM_buff[rec_counter]=tmp; 
 477   3                              buffer_star=1;
 478   3                              rec_counter++;
 479   3                              COMMFLASH=1;
 480   3                              ReceiveIndicateCount=1; //CommLedFlash Delay Count
 481   3                              ReceiveTimeoutCount=RECEIVE_TIMEOUT; 
 482   3                      }                      
 483   2                      else
 484   2                      {
 485   3                              if(rec_counter<=(COMM_LENTH-1)&&buffer_star==1)
 486   3                              {
 487   4                                      COMMFLASH=1;
C51 COMPILER V8.18   XY_LC301                                                              06/27/2012 09:59:54 PAGE 9   

 488   4                                      ReceiveIndicateCount=1;
 489   4                                      ReceiveTimeoutCount=RECEIVE_TIMEOUT;
 490   4                                      COMM_buff[rec_counter]=tmp; 
 491   4                                      if(rec_counter==(COMM_LENTH-1))
 492   4                                      {
 493   5                                              rec_counter=0;
 494   5                                              buffer_star=0;
 495   5                                              ReceiveTimeoutCount=0;  //Êý¾ÝÖ¡½ÓÊÕÍê£¬Çå³ý³¬Ê±Éè¶¨Öµ
 496   5                                              buffer_sto=1;
 497   5                                      }
 498   4                                      else
 499   4                                              rec_counter++;
 500   4                              }
 501   3                      } 
 502   2                      WDT=!WDT;
 503   2              }
 504   1              else
 505   1              {
 506   2                      TI=0;
 507   2                      bTXok=1;
 508   2              }
 509   1      }
 510          //==============================================================================================
 511          //Common.c
 512          //==============================================================================================
 513          void judge_rec_message()
 514          {
 515   1              unsigned char i,j;
 516   1              FeedDog();
 517   1              if(COMM_buff[0]==0x02&&COMM_buff[22]==0x03)
 518   1              {
 519   2                      j=COMM_buff[1];
 520   2                      for(i=2;i<=(COMM_LENTH-3);i++)
 521   2                              j=COMM_buff[i]^j;
 522   2                      if(j==COMM_buff[COMM_LENTH-1])
 523   2                              message_right=1;
 524   2                      else
 525   2                              message_wrong=1;
 526   2              }
 527   1              else
 528   1              {
 529   2                      message_wrong=1;
 530   2              }
 531   1      }
 532          //==============================================================================================
 533          void send_mess(unsigned char n)
 534          {
 535   1              unsigned int addtmp=1000;
 536   1              WDT=!WDT;
 537   1              COMMFLASH=1;
 538   1              bTXok=0;
 539   1              SBUF=n;
 540   1              while(1)
 541   1              {
 542   2                      if(bTXok) break;
 543   2                      addtmp--;
 544   2                      if(addtmp==0) break;
 545   2              }
 546   1              COMMFLASH=0;
 547   1              WDT=!WDT;
 548   1      }
 549          //==============================================================================================
C51 COMPILER V8.18   XY_LC301                                                              06/27/2012 09:59:54 PAGE 10  

 550          void ddl_200us(int x)
 551          {
 552   1              unsigned char j;
 553   1              while(x--)
 554   1              {
 555   2                      for(j=0;j<33;j++)
 556   2                      {WDT=!WDT; _nop_(); _nop_(); _nop_(); _nop_();}
 557   2              }
 558   1      }
 559          
 560          //==============================================================================================
 561          void timer0_int_entry() interrupt 1 using 1
 562          {
 563   1              static char DidaCount=0;
 564   1              static bit bReEntry=0;
 565   1              TH0=0xB8;TL0=0x12;                //20ms
 566   1              if(bReEntry) return;    //ÖØÈë´¦Àí£¬ºÃÏóÏµÍ³±¾Éí¾ßÓÐÕâ
 567   1      
 568   1              WDT=!WDT;
 569   1              bReEntry=1;
 570   1              DidaCount++;                    //Î¢µ÷
 571   1              if(DidaCount<10) {bReEntry=0; return;}
 572   1      
 573   1              DidaCount=0;
 574   1      
 575   1              //codes below execute every 200ms
 576   1              if(WatchingDelayCount>0)
 577   1              {
 578   2                      WatchingDelayCount--;
 579   2                      if(WatchingDelayCount==0) watching_car_passing=0;
 580   2              }
 581   1              if(ReceiveIndicateCount>0)
 582   1              {
 583   2                      ReceiveIndicateCount--;
 584   2                      if(ReceiveIndicateCount==0)     COMMFLASH=0;    //Close LED
 585   2              }
 586   1      
 587   1              if(ReceiveTimeoutCount>0)
 588   1              {
 589   2                      ReceiveTimeoutCount--;
 590   2                      if(ReceiveTimeoutCount==0)
 591   2                              {buffer_star=0; buffer_sto=0;}  //½ÓÊÕ³¬¹ýÊ±¼ä¸´Î»
 592   2              }
 593   1      
 594   1      
 595   1              if(detect_time_counter>0)
 596   1                      detect_time_counter--;
 597   1              else
 598   1              {
 599   2                      bALGTTLAutoDetect=1;
 600   2                      detect_time_counter=AUTO_DETCET_TIME;
 601   2              }
 602   1              if(alarm_time_counter>0)
 603   1              {
 604   2                      alarm_time_counter--;
 605   2                      if(alarm_time_counter==0)
 606   2                      {
 607   3                              VOX_ALM=1;      //STOP Alarm
 608   3                              LIGHT_ALM=1;
 609   3                      }
 610   2              }
 611   1      
C51 COMPILER V8.18   XY_LC301                                                              06/27/2012 09:59:54 PAGE 11  

 612   1              bReEntry=0;
 613   1      }
 614          //==============================================================================================
 615          void detect_device(void)
 616          {
 617   1              unsigned char outside_tmp,outside_tmp1;
 618   1      
 619   1              FeedDog();
 620   1              outside_tmp=P2;
 621   1              if(outside_tmp!=device_status_char1)
 622   1              {
 623   2                      outside_tmp1=outside_tmp;
 624   2                      ddl_200us(60);  //80-40ms ;//40-20ms ;//60-30ms ;//20-10ms ;//100-50ms
 625   2                      outside_tmp=P2;
 626   2                      if(outside_tmp==outside_tmp1)
 627   2                      {
 628   3                              dete_change=1;
 629   3                              device_status_char1=outside_tmp;
 630   3                              if(ALG_detect_bit==0) watching_car_passing=0; 
 631   3                      }
 632   2              }
 633   1      }
 634          
 635          //==============================================================================================
 636          bit  detect_ALG_TTL_working(void)
 637          {
 638   1                      FeedDog();
 639   1                      //detect_device();
 640   1      
 641   1                      if(ALG_up_flag_bit==1)
 642   1                      {
 643   2                                              if(ALG_detect_bit==1)   ALG_work_status=0;      //Ì§¸Ë×´Ì¬
 644   2                                              else                                ALG_work_status=1;  //ÕýÔÚÌ§¸Ë»ò³ö´í
 645   2                      }
 646   1                      
 647   1                      if(ALG_down_flag_bit==1)
 648   1                      {
 649   2                                              if(ALG_detect_bit==0)   ALG_work_status=0;      //½µ¸Ë×´Ì¬
 650   2                                              else                                    ALG_work_status=1;      //ÕýÔÚ½µ¸Ë»ò³ö´í
 651   2                      }
 652   1                      
 653   1                      if(TTL_green_bit==TTL_detect_bit)
 654   1                      {
 655   2                                               TTL_work_status=0;
 656   2                      }
 657   1                      else TTL_work_status=1;
 658   1      
 659   1      
 660   1      
 661   1                      if(TTL_work_status==1||ALG_work_status==1)      // ALG/TTL_work_status=0, working normal
 662   1                                              return 1;
 663   1                      else            return 0;
 664   1      
 665   1      }
 666          //==============================================================================================
 667          // Test all extern device if work normal
 668          void system_auto_detect()
 669          {
 670   1              //  unsigned char i,j;
 671   1              FeedDog();
 672   1      
 673   1              BAK2_USED=0;
C51 COMPILER V8.18   XY_LC301                                                              06/27/2012 09:59:54 PAGE 12  

 674   1              COMMFLASH=1;
 675   1              ddl_200us(505);WDT=0;WDT=1;
 676   1              ddl_200us(505);WDT=0;WDT=1;
 677   1              ddl_200us(505);WDT=0;WDT=1;
 678   1              ddl_200us(505);WDT=0;WDT=1;
 679   1              ddl_200us(505);WDT=0;WDT=1;
 680   1              sys_tmep=P2;                            //(8-chanel input-detect legcy to P2)
 681   1      
 682   1              if(sys_tmep_b7==0)
 683   1              {
 684   2                      BAK2_USED=1;
 685   2                      ddl_200us(505);WDT=0;WDT=1;
 686   2                      ddl_200us(505);WDT=0;WDT=1;
 687   2                      ddl_200us(505);WDT=0;WDT=1;
 688   2                      ddl_200us(505);WDT=0;WDT=1;
 689   2                      ddl_200us(505);WDT=0;WDT=1;
 690   2                      sys_tmep=P2;
 691   2      
 692   2                      if(sys_tmep_b7==1)
 693   2                              COMMFLASH=0;
 694   2                      else
 695   2                      {
 696   3                              BAK2_USED=0;
 697   3                              COMMFLASH=0;
 698   3                      }
 699   2      
 700   2                      ddl_200us(505);WDT=0;WDT=1;
 701   2                      ddl_200us(505);WDT=0;WDT=1;
 702   2                      ddl_200us(505);WDT=0;WDT=1;
 703   2                      COMMFLASH=1;
 704   2                      BAK1_USED=0;
 705   2                      ddl_200us(505);WDT=0;WDT=1;
 706   2                      ddl_200us(505);WDT=0;WDT=1;
 707   2                      ddl_200us(505);WDT=0;WDT=1;
 708   2      
 709   2                      sys_tmep=P2;
 710   2                      if(sys_tmep_b6==0)
 711   2                      {
 712   3                              BAK1_USED=1;
 713   3                              ddl_200us(505);WDT=0;WDT=1;
 714   3                              ddl_200us(505);WDT=0;WDT=1;
 715   3                              ddl_200us(505);WDT=0;WDT=1;
 716   3                              sys_tmep=P2;
 717   3                              if(sys_tmep_b6==1){COMMFLASH=0;}
 718   3                              else{BAK1_USED=0;COMMFLASH=0;}
 719   3                      }
 720   2      
 721   2                      ddl_200us(505);WDT=0;WDT=1;
 722   2                      ddl_200us(505);WDT=0;WDT=1;
 723   2                      ddl_200us(505);WDT=0;WDT=1;
 724   2      
 725   2                      COMMFLASH=1;                            //start test lamp
 726   2                      LAN_LAMP=0;                             //Open Lamp
 727   2                      ddl_200us(505);WDT=0;WDT=1;
 728   2                      ddl_200us(505);WDT=0;WDT=1;     //delay
 729   2                      ddl_200us(505);WDT=0;WDT=1;
 730   2      
 731   2                      sys_tmep=P2;                            //read status
 732   2                      if(sys_tmep_b5==0)                      //if open Lamp success
 733   2                      {
 734   3                              LAN_LAMP=1;                     //close lamp
 735   3                              ddl_200us(505);WDT=0;WDT=1;
C51 COMPILER V8.18   XY_LC301                                                              06/27/2012 09:59:54 PAGE 13  

 736   3                              ddl_200us(505);WDT=0;WDT=1;
 737   3                              ddl_200us(505);WDT=0;WDT=1;
 738   3                              sys_tmep=P2;                    //read lamp status again
 739   3                                                 
 740   3                              if(sys_tmep_b5==1)              //if close lamp suceess
 741   3                                      COMMFLASH=0;            //finish test lamp
 742   3                              else
 743   3                              {
 744   4                                      LAN_LAMP=0;             //if close lamp fail, LED indicate fail chanel
 745   4                                      COMMFLASH=0;            //finish test lamp
 746   4                              }
 747   3                      }
 748   2                             
 749   2                      ddl_200us(505);WDT=0;WDT=1;
 750   2                      ddl_200us(505);WDT=0;WDT=1;
 751   2                      ddl_200us(505);WDT=0;WDT=1;
 752   2                      COMMFLASH=1;
 753   2                      LIGHT_ALM=0;
 754   2                      ddl_200us(505);WDT=0;WDT=1;
 755   2                      ddl_200us(505);WDT=0;WDT=1;
 756   2                      ddl_200us(505);WDT=0;WDT=1;
 757   2                      
 758   2                      sys_tmep=P2;                   
 759   2                      if(sys_tmep_b4==0)
 760   2                      {
 761   3                              LIGHT_ALM=1;
 762   3                              ddl_200us(505);WDT=0;WDT=1;
 763   3                              ddl_200us(505);WDT=0;WDT=1;
 764   3                              ddl_200us(505);WDT=0;WDT=1;
 765   3                              sys_tmep=P2;
 766   3                              if(sys_tmep_b4==1)
 767   3                                      COMMFLASH=0;
 768   3                              else
 769   3                              {
 770   4                                      LIGHT_ALM=0;
 771   4                                      COMMFLASH=0;
 772   4                              }
 773   3                      }
 774   2                                                 
 775   2                      ddl_200us(505);WDT=0;WDT=1;
 776   2                      ddl_200us(505);WDT=0;WDT=1;
 777   2                      ddl_200us(505);WDT=0;WDT=1;
 778   2      
 779   2                      COMMFLASH=1;
 780   2                      VOX_ALM=0;
 781   2                      ddl_200us(505);WDT=0;WDT=1;
 782   2                      ddl_200us(505);WDT=0;WDT=1;
 783   2                      ddl_200us(505);WDT=0;WDT=1;
 784   2      
 785   2                      sys_tmep=P2;                   
 786   2                      if(sys_tmep_b3==0)
 787   2                      {
 788   3                              VOX_ALM=1;
 789   3                              ddl_200us(505);WDT=0;WDT=1;
 790   3                              ddl_200us(505);WDT=0;WDT=1;
 791   3                              ddl_200us(505);WDT=0;WDT=1;
 792   3                              sys_tmep=P2;
 793   3                              if(sys_tmep_b3==1)
 794   3                                      COMMFLASH=0;
 795   3                              else
 796   3                              {
 797   4                                      VOX_ALM=0;
C51 COMPILER V8.18   XY_LC301                                                              06/27/2012 09:59:54 PAGE 14  

 798   4                                      COMMFLASH=0;
 799   4                              }
 800   3                      }
 801   2      
 802   2                      ddl_200us(505);WDT=0;WDT=1;
 803   2                      ddl_200us(505);WDT=0;WDT=1;
 804   2                      ddl_200us(505);WDT=0;WDT=1;
 805   2                      COMMFLASH=1;
 806   2                      TTL_GREEN=0;
 807   2                      ddl_200us(505);WDT=0;WDT=1;
 808   2                      ddl_200us(505);WDT=0;
 809   2                      WDT=1;ddl_200us(505);
 810   2                      WDT=0;WDT=1;
 811   2      
 812   2                      sys_tmep=P2;                   
 813   2                      if(sys_tmep_b2==0)
 814   2                      {
 815   3                              TTL_GREEN=1;
 816   3                              ddl_200us(505);WDT=0;WDT=1;
 817   3                              ddl_200us(505);WDT=0;WDT=1;
 818   3                              ddl_200us(505);WDT=0;WDT=1;
 819   3      
 820   3                              sys_tmep=P2;
 821   3                              if(sys_tmep_b2==1)
 822   3                                      COMMFLASH=0;
 823   3                              else
 824   3                              {
 825   4                                      TTL_GREEN=0;
 826   4                                      COMMFLASH=0;
 827   4                              }
 828   3                      }
 829   2        
 830   2                      ddl_200us(505);WDT=0;WDT=1;
 831   2                      ddl_200us(505);WDT=0;WDT=1;
 832   2                      ddl_200us(505);WDT=0;WDT=1;
 833   2                      COMMFLASH=1;
 834   2                      BAR_DOWN=0;
 835   2                      ddl_200us(505);WDT=0;WDT=1;
 836   2                      ddl_200us(505);WDT=0;WDT=1;
 837   2                      ddl_200us(505);WDT=0;WDT=1;
 838   2                      
 839   2                      sys_tmep=P2;                   
 840   2                      if(sys_tmep_b1==0)
 841   2                      {
 842   3                              BAR_DOWN=1;
 843   3                              ddl_200us(505);WDT=0;WDT=1;
 844   3                              ddl_200us(505);WDT=0;WDT=1;
 845   3                              ddl_200us(505);WDT=0;WDT=1;
 846   3                              sys_tmep=P2;
 847   3                              if(sys_tmep_b1==1)
 848   3                                      COMMFLASH=0;
 849   3                              else
 850   3                              {
 851   4                                      BAR_DOWN=0;
 852   4                                      COMMFLASH=0;
 853   4                              }
 854   3                      }
 855   2      
 856   2                      ddl_200us(505);WDT=0;WDT=1;
 857   2                      ddl_200us(505);WDT=0;WDT=1;
 858   2                      ddl_200us(505);WDT=0;WDT=1;
 859   2                      COMMFLASH=1;
C51 COMPILER V8.18   XY_LC301                                                              06/27/2012 09:59:54 PAGE 15  

 860   2                      BAR_UP=0;
 861   2                      ddl_200us(505);WDT=0;WDT=1;
 862   2                      ddl_200us(505);WDT=0;WDT=1;
 863   2                      ddl_200us(505);WDT=0;WDT=1;
 864   2      
 865   2                      sys_tmep=P2;                   
 866   2                      if(sys_tmep_b0==0)
 867   2                      {
 868   3                              BAR_UP=1;
 869   3                              ddl_200us(505);WDT=0;WDT=1;
 870   3                              ddl_200us(505);WDT=0;WDT=1;
 871   3                              ddl_200us(505);WDT=0;WDT=1;
 872   3                              sys_tmep=P2;
 873   3                              if(sys_tmep_b0==1)
 874   3                                      COMMFLASH=0;
 875   3                              else
 876   3                              {       
 877   4                                      BAR_UP=0;
 878   4                                      COMMFLASH=0;
 879   4                              }
 880   3                      }
 881   2                              
 882   2                      TOVOX=1;TOFEE=1;TOCPU=0;
 883   2                      //j=COMM_buff[4];
 884   2                      //for(i=5;i<=19;i++)
 885   2                      //      j=j^COMM_buff[i]; //bcc
 886   2                      send_mess(0x02);
 887   2                      send_mess('3'); //chexing
 888   2                      send_mess('3'); //chezhong
 889   2                      send_mess('5');
 890   2                      send_mess('5');
 891   2                      send_mess('0');
 892   2                      send_mess('0');  //fee
 893   2                      send_mess('0');
 894   2                      send_mess('0');
 895   2                      send_mess('3');
 896   2                      send_mess('3');//bal
 897   2                      send_mess('4');
 898   2                      send_mess('4');
 899   2                      send_mess('4');
 900   2                      send_mess('4');
 901   2                      send_mess('4');
 902   2                      send_mess('4');//entrance
 903   2                      send_mess(0x03);
 904   2                      send_mess(0x00);
 905   2                      TOVOX=0;TOFEE=0;TOCPU=1;
 906   2             
 907   2                      ddl_200us(505);WDT=0;WDT=1;
 908   2                      ddl_200us(505);WDT=0;WDT=1;
 909   2                      ddl_200us(505);WDT=0;WDT=1;
 910   2                      ddl_200us(505);WDT=0;WDT=1;
 911   2                      ddl_200us(505);WDT=0;WDT=1;
 912   2                      ddl_200us(505);WDT=0;WDT=1;
 913   2                      COMMFLASH=1;
 914   2                      ddl_200us(505);WDT=0;WDT=1;
 915   2                      ddl_200us(505);WDT=0;WDT=1;
 916   2                      ddl_200us(505);WDT=0;WDT=1;
 917   2                      ddl_200us(505);WDT=0;WDT=1;
 918   2                      ddl_200us(505);WDT=0;WDT=1;
 919   2                      ddl_200us(505);WDT=0;WDT=1;
 920   2                      COMMFLASH=0;
 921   2                      ddl_200us(505);WDT=0;WDT=1;
C51 COMPILER V8.18   XY_LC301                                                              06/27/2012 09:59:54 PAGE 16  

 922   2                      ddl_200us(505);WDT=0;WDT=1;
 923   2                      ddl_200us(505);WDT=0;WDT=1;
 924   2                      ddl_200us(505);WDT=0;WDT=1;
 925   2                      ddl_200us(505);WDT=0;WDT=1;
 926   2                      ddl_200us(505);WDT=0;WDT=1;
 927   2                      COMMFLASH=1;
 928   2                      ddl_200us(505);WDT=0;WDT=1;
 929   2                      ddl_200us(505);WDT=0;WDT=1;
 930   2                      ddl_200us(505);WDT=0;WDT=1;
 931   2                      ddl_200us(505);WDT=0;WDT=1;
 932   2                      ddl_200us(505);WDT=0;WDT=1;
 933   2                      ddl_200us(505);WDT=0;WDT=1;
 934   2                      COMMFLASH=0;
 935   2                      ddl_200us(505);WDT=0;WDT=1;
 936   2                      ddl_200us(505);WDT=0;WDT=1;
 937   2                      ddl_200us(505);WDT=0;WDT=1;
 938   2                      ddl_200us(505);WDT=0;WDT=1;
 939   2                      ddl_200us(505);WDT=0;WDT=1;
 940   2                      ddl_200us(505);WDT=0;WDT=1;
 941   2                      COMMFLASH=1;
 942   2                      ddl_200us(505);WDT=0;WDT=1;
 943   2                      ddl_200us(505);WDT=0;WDT=1;
 944   2                      ddl_200us(505);WDT=0;WDT=1;
 945   2                      ddl_200us(505);WDT=0;WDT=1;
 946   2                      ddl_200us(505);WDT=0;WDT=1;
 947   2                      ddl_200us(505);WDT=0;WDT=1;
 948   2                      COMMFLASH=0;
 949   2                      ddl_200us(505);WDT=0;WDT=1;
 950   2                      ddl_200us(505);WDT=0;WDT=1;
 951   2                      ddl_200us(505);WDT=0;WDT=1;
 952   2                      ddl_200us(505);WDT=0;WDT=1;
 953   2                      ddl_200us(505);WDT=0;WDT=1;
 954   2                      ddl_200us(505);WDT=0;WDT=1;
 955   2                      COMMFLASH=1;
 956   2                      ddl_200us(505);WDT=0;WDT=1;
 957   2                      ddl_200us(505);WDT=0;WDT=1;
 958   2                      ddl_200us(505);WDT=0;WDT=1;
 959   2                      ddl_200us(505);WDT=0;WDT=1;
 960   2                      ddl_200us(505);WDT=0;WDT=1;
 961   2                      ddl_200us(505);WDT=0;WDT=1;
 962   2                      COMMFLASH=0;
 963   2                                                
 964   2                      TOVOX=1;TOFEE=1;TOCPU=0;
 965   2                      send_mess(0x02);
 966   2                      send_mess('Y');
 967   2                      send_mess(0x03);
 968   2                      send_mess('Y');
 969   2                      TOVOX=0;TOFEE=0;TOCPU=1;
 970   2                              
 971   2                      ddl_200us(505);WDT=0;WDT=1;
 972   2                      ddl_200us(505);WDT=0;WDT=1;
 973   2                      ddl_200us(505);WDT=0;WDT=1;
 974   2                      ddl_200us(505);WDT=0;WDT=1;
 975   2                      ddl_200us(505);WDT=0;WDT=1;
 976   2                      ddl_200us(505);WDT=0;WDT=1;
 977   2                      ddl_200us(505);WDT=0;WDT=1;
 978   2                      ddl_200us(505);WDT=0;WDT=1;
 979   2                      ddl_200us(505);WDT=0;WDT=1;
 980   2                      ddl_200us(505);WDT=0;WDT=1;
 981   2                      ddl_200us(505);WDT=0;WDT=1;
 982   2                      ddl_200us(505);WDT=0;WDT=1;
 983   2      
C51 COMPILER V8.18   XY_LC301                                                              06/27/2012 09:59:54 PAGE 17  

 984   2                      TOVOX=1;TOFEE=1;TOCPU=0;
 985   2                      send_mess(0x02);
 986   2                      send_mess('Z');
 987   2                      send_mess(0x03);
 988   2                      send_mess('Z');
 989   2                      TOVOX=0;TOFEE=0;TOCPU=1;
 990   2              }
 991   1              else
 992   1              {
 993   2                      BAK2_USED=1;
 994   2                      COMMFLASH=0;
 995   2              }                  
 996   1      }
 997          
 998          //==============================================================================================
 999          //control.c
1000          //==============================================================================================
1001          void ONE_FEEdisplay_Red()
1002          {
1003   1              TOVOX=0;TOFEE=1;TOCPU=0;
1004   1              ddl_200us(4);   //delay 2ms
1005   1      //      send_mess(0x02);                   //P20100607--
1006   1      //      send_mess(GetControlChar());
1007   1      //      send_mess(0x03);
1008   1      //      send_mess(GetControlChar());
1009   1              FeedDog();
1010   1              send_mess(0x02);        //Close Lane lamp
1011   1              send_mess('Z');
1012   1              send_mess(0x03);
1013   1              send_mess('Z');
1014   1              bLastLaneRedGreenOperateState=RED;
1015   1              TOVOX=0;TOFEE=0;TOCPU=1;
1016   1      }
1017          
1018          //==============================================================================================
1019          void ONE_FEEdisplay_Green()
1020          {
1021   1              TOVOX=0;TOFEE=1;TOCPU=0;
1022   1              ddl_200us(4);   //delay 2ms
1023   1      //      send_mess(0x02);                                 //P20100607--
1024   1      //      send_mess(GetControlChar());
1025   1      //      send_mess(0x03);
1026   1      //      send_mess(GetControlChar());
1027   1              FeedDog();
1028   1              _nop_();
1029   1              _nop_();
1030   1              send_mess(0x02);
1031   1              send_mess('Y');
1032   1              send_mess(0x03);        //Open Lane Lamp
1033   1              send_mess('Y');
1034   1              bLastLaneRedGreenOperateState=GREEN;
1035   1              TOVOX=0;TOFEE=0;TOCPU=1;
1036   1      }
1037          //==============================================================================================
1038          void ClearFEEdisplay(void)
1039          {
1040   1              if (bFeeCleared) return;
1041   1      
1042   1              FeedDog();
1043   1              bFeeCleared=1;
1044   1              if(bLastLaneRedGreenOperateState==GREEN)
1045   1              {
C51 COMPILER V8.18   XY_LC301                                                              06/27/2012 09:59:54 PAGE 18  

1046   2                      if(bFeeDispSelection==0)
1047   2                              ONE_FEEdisplay_Green();         //¶ÔÓÚÉÂÎ÷°æ±¾µÄ·ÑÏÔ£¬Ö»Òª¿ªÂÌµÆ²»Çå³ý·Ñ¶î
1048   2                      else ONE_FEEdisplay_Red();           //¶ÔÓÚ¹ã¶«°æ±¾µÄ·ÑÏÔ£¬Ö»Òª¿ªÂÌµÆ»òºìµÆ¶¼Çå³ý·Ñ¶î
1049   2              }
1050   1              else ONE_FEEdisplay_Red();      //²»¹ÜÊÇÄÄ¸ö°æ±¾µÄ·ÑÏÔ£¬Ö»Òª¿ªºìµÆ¶¼Çå³ý·Ñ¶î
1051   1      }
1052          //==============================================================================================
1053          void control_device()
1054          {
1055   1              FeedDog();
1056   1      
1057   1              BAR_DOWN=1;BAR_UP=1;
1058   1      //--------À¸¸Ë¿ØÖÆ---------------------
1059   1              //control_char1=COMM_buff[3];
1060   1              if(ALG_down_bit==1)
1061   1              {
1062   2                      detect_device();                 //ºóÏßÈ¦×´Ì¬Ë¢ÐÂ  P20200607+
1063   2                      if(BACK_coil_bit==1) {      //ºóÏßÈ¦Ã»³µÊ±²ÅÂä¸Ë  P20100603£«
1064   3                              ONE_FEEdisplay_Red();
1065   3      
1066   3                              pinSwtichALG=0; //0½µ¸Ë
1067   3                              BAR_DOWN=0;             //Valid level: low, Pusle to DOWN LG
1068   3                              WatchingDelayCount=20;  //20*200us=4 senconds     20*20ms=400ms
1069   3      
1070   3                              ALG_down_flag_bit=1;
1071   3                              ALG_up_flag_bit=0;
1072   3                      }else{                                                    //P20100603£«
1073   3                              bEnBarAutoDown=1;             //ºóÏßÈ¦ÓÐ³µ£¬ÓÃ×Ô¶¯Âä¸ËP20100603£«
1074   3                      }
1075   2              }
1076   1      
1077   1              if(ALG_up_bit==1)
1078   1              {
1079   2                      ONE_FEEdisplay_Green();
1080   2      
1081   2                      pinSwtichALG=1; //1Ì§¸Ë
1082   2                      BAR_UP=0;                       //Valid level: low, Pusle to UP LG
1083   2      
1084   2                      ALG_up_flag_bit=1;
1085   2                      ALG_down_flag_bit=0;
1086   2              }
1087   1      //-------------------------------------
1088   1      
1089   1              if(TTL_green_bit==1)
1090   1                              TTL_GREEN=0;
1091   1              else    TTL_GREEN=1;
1092   1      
1093   1              if(VOX_alarm_bit==1)
1094   1                              VOX_ALM=0;
1095   1              else    VOX_ALM=1;
1096   1      
1097   1              if(Light_alarm_bit==1)
1098   1                              LIGHT_ALM=0;
1099   1              else    LIGHT_ALM=1;
1100   1      
1101   1              if(Lane_lamp_bit==1)
1102   1                              LAN_LAMP=0;
1103   1              else    LAN_LAMP=1;
1104   1              LastLaneLampState=Lane_lamp_bit;
1105   1      
1106   1      
1107   1      //--------------------------------------
C51 COMPILER V8.18   XY_LC301                                                              06/27/2012 09:59:54 PAGE 19  

1108   1              ddl_200us(505);                                    //244  ms  (P)
1109   1              BAR_DOWN=1;BAR_UP=1;
1110   1              detect_time_counter=AUTO_DETCET_TIME;
1111   1      }
1112          
1113          //==============================================================================================
1114          void control_speaker()
1115          {
1116   1              unsigned char i,j;
1117   1              //control_char1=COMM_buff[3];
1118   1      
1119   1              FeedDog();
1120   1              if(ALG_up_bit==0&&ALG_down_bit==0)
1121   1              {
1122   2                      TOVOX=1;TOFEE=0;TOCPU=1;
1123   2                      ddl_200us(4);   //delay 2ms
1124   2                      j=COMM_buff[4];
1125   2      
1126   2                      for(i=5;i<=19;i++)
1127   2                              j=j^COMM_buff[i];       //bcc
1128   2                      send_mess(0x02);
1129   2                      send_mess(COMM_buff[18]); //chexing
1130   2                      send_mess(COMM_buff[19]); //chezhong
1131   2                      send_mess(COMM_buff[4]);
1132   2                      send_mess(COMM_buff[5]);
1133   2                      send_mess(COMM_buff[6]);
1134   2                      send_mess(COMM_buff[7]);        //fee
1135   2                      send_mess(COMM_buff[8]);
1136   2                      send_mess(COMM_buff[9]);
1137   2                      send_mess(COMM_buff[10]);
1138   2                      send_mess(COMM_buff[11]);//bal
1139   2                      send_mess(COMM_buff[12]);
1140   2                      send_mess(COMM_buff[13]);
1141   2                      send_mess(COMM_buff[14]);
1142   2                      send_mess(COMM_buff[15]);
1143   2                      send_mess(COMM_buff[16]);
1144   2                      send_mess(COMM_buff[17]);//entrance
1145   2                      send_mess(0x03);
1146   2                      send_mess(j);
1147   2                      TOVOX=0;TOFEE=0;TOCPU=1;
1148   2              }
1149   1              
1150   1              if(ALG_up_bit==1)
1151   1              {
1152   2                      TOVOX=1;TOFEE=0;TOCPU=1;
1153   2                      ddl_200us(4);   //delay 2ms
1154   2                      send_mess(0x02);
1155   2                      send_mess('Y');
1156   2                      send_mess(0x03);
1157   2                      send_mess('Y');
1158   2                      TOVOX=0;TOFEE=0;TOCPU=1;
1159   2              }   
1160   1      }
1161          //==============================================================================================
1162          //³ýÀ¸¸ËÍâµÄÉè±¸×´Ì¬±£³Ö¿ØÖÆ
1163          void device_keep()
1164          {
1165   1              FeedDog();
1166   1              if(TTL_green_bit==1)
1167   1                      TTL_GREEN=0;
1168   1              else    TTL_GREEN=1;
1169   1      
C51 COMPILER V8.18   XY_LC301                                                              06/27/2012 09:59:54 PAGE 20  

1170   1              if(VOX_alarm_bit==1)
1171   1                      VOX_ALM=0;
1172   1              else    VOX_ALM=1;
1173   1              
1174   1              if(Light_alarm_bit==1)
1175   1                      LIGHT_ALM=0;
1176   1              else    LIGHT_ALM=1;
1177   1              
1178   1              if(Lane_lamp_bit==1)
1179   1                      LAN_LAMP=0;
1180   1              else    LAN_LAMP=1;    
1181   1      }
1182          //================================================================================================
1183          #ifdef TEST
              void send_test()
              {
                      TOVOX=1;TOFEE=1;TOCPU=0;
                      ddl_200us(4)    //delay 2ms
                      FeedDog();
                      send_mess(0x80);
                      send_mess(0x3f);send_mess(0x30);send_mess(0x5b);
                      send_mess(0x4f);send_mess(0x66);send_mess(0x6d);send_mess(0x7d);send_mess(0x07);
                      send_mess(0x7f);
                      send_mess(0x01);
                      TOVOX=0;TOFEE=0;TOCPU=1;
              }
              #endif
1197          //==============================================================================================
1198          /***********************************************
1199          //codes below added by Liu XingZhou, 2004/05/15
1200          ***********************************************/
1201          //#include "Addtional.h"
1202          //==============================================================================================
1203          void UpdateFEEdisplay(void)
1204          {
1205   1              unsigned char i,j;
1206   1              TOVOX=0;TOFEE=1;TOCPU=0;
1207   1              ddl_200us(4);   //delay 2ms
1208   1              FeedDog();
1209   1                      j=COMM_buff[4];
1210   1                      for(i=5;i<=19;i++)
1211   1                              j=j^COMM_buff[i];       //bcc
1212   1                      send_mess(0x02);
1213   1                      send_mess(COMM_buff[18]); //chexing
1214   1                      send_mess(COMM_buff[19]); //chezhong
1215   1                      send_mess(COMM_buff[4]);
1216   1                      send_mess(COMM_buff[5]);
1217   1                      send_mess(COMM_buff[6]);
1218   1                      send_mess(COMM_buff[7]);  //fee
1219   1                      send_mess(COMM_buff[8]);
1220   1                      send_mess(COMM_buff[9]);
1221   1                      send_mess(COMM_buff[10]);
1222   1                      send_mess(COMM_buff[11]);//bal
1223   1                      send_mess(COMM_buff[12]);
1224   1                      send_mess(COMM_buff[13]);
1225   1                      send_mess(COMM_buff[14]);
1226   1                      send_mess(COMM_buff[15]);
1227   1                      send_mess(COMM_buff[16]);
1228   1                      send_mess(COMM_buff[17]);//entrance
1229   1                      send_mess(0x03);
1230   1                      send_mess(j);
1231   1              bFeeCleared=0;
C51 COMPILER V8.18   XY_LC301                                                              06/27/2012 09:59:54 PAGE 21  

1232   1              TOVOX=0;TOFEE=0;TOCPU=1;
1233   1      }
1234          //==============================================================================================
1235          /*bit AutoBarDowningDetect(void)        //run after detect_deivce()
1236          {
1237                  if(ALG_down_flag_bit==1)                //ÒÑ¾­·¢ËÍ½µ¸ËÃüÁî
1238                  {
1239                          if(ALG_detect_bit==1)   //À¸¸ËÈÔÎªÌ§¸Ë×´Ì¬
1240                          {
1241                                  return 1;
1242                          }
1243                  }
1244                  return 0;
1245          }*/
1246          //==============================================================================================
1247          /*
1248          sbit  ALG_up_bit      =control_char1^0; 
1249          sbit  ALG_down_bit    =control_char1^1;
1250          sbit  Lane_lamp_bit   =control_char1^5;
1251          */
1252          void BarOpRectifyLaneLamp(void)
1253          {
1254   1              if(ALG_up_bit&ALG_down_bit) //return;   //´íÎó²Ù×÷
1255   1                      ALG_down_bit=0;
1256   1              FeedDog();
1257   1              if(ALG_up_bit) Lane_lamp_bit=1;         //ÂÌµÆ
1258   1              if(ALG_down_bit) Lane_lamp_bit=0;       //ºìµÆ
1259   1              if((ALG_up_bit|ALG_down_bit)==0) Lane_lamp_bit=LastLaneLampState;
1260   1      }
1261          //==============================================================================================
1262          void FeedDog(void)
1263          {
1264   1              WDT=0;
1265   1              _nop_();
1266   1              _nop_();
1267   1              _nop_();
1268   1          WDT=1;
1269   1      }
1270          //==============================================================================================
1271          char GetControlChar()
1272          {
1273   1              if(bFeeDispSelection)   //·ÑÏÔÑ¡Ôñ£¬1-ÎÞ±£³Ö¹¦ÄÜµÄ¹ã¶«ÓÃ°æ±¾£¬0-ÓÐ±£³Ö¹¦ÄÜµÄÉ½Î÷°æ±¾
1274   1              {
1275   2                      if(bControlOption)      //³µ¿ØÆ÷Ê¹ÓÃÊôÐÔ: 1-³ö¿Ú, 0-Èë¿Ú
1276   2                              return 'A';
1277   2                      else return 'B';
1278   2              }
1279   1              else
1280   1              {
1281   2                      if(bControlOption)      //³µ¿ØÆ÷Ê¹ÓÃÊôÐÔ: 1-³ö¿Ú, 0-Èë¿Ú
1282   2                              return 'C';
1283   2                      else return 'D';
1284   2              }
1285   1      }
1286          //==============================================================================================


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2462    ----
   CONSTANT SIZE    =     79    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
C51 COMPILER V8.18   XY_LC301                                                              06/27/2012 09:59:54 PAGE 22  

   DATA SIZE        =     46       6
   IDATA SIZE       =   ----    ----
   BIT SIZE         =     21    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
